package gss.ETLCode.bin;

import java.util.Map;

public class BEFORE_C01_Run {
	
	public static String getHQL(String partition, Map<String, String> mapProp, String tableName ) {
		
		String rs = "-----------------------------------------------------------------\n"
				+ "-- parameter list\n"
				+ "-----------------------------------------------------------------\n"
				+ "set hivevar:Run_TableName="+tableName+";\n"
				+ "set hivevar:RUN_TYPE=A;\n"
				+ "set hivevar:DATA_S=20221201;\n"
				+ "set hivevar:DATA_E=20221231;\n"
				+ "set hivevar:DES1_RUN="+mapProp.get("hadoop.std.dbname")+".SYS_RUN_NOW;\n"
				+ "set hivevar:SRC1_RUN="+mapProp.get("hadoop.std.dbname")+".SYS_RUN_INFO;\n"
				+ "\n"
				+ "set hivevar:BATCHID=20230329000000;\n"
				+ "set hivevar:RSLT="+mapProp.get("hadoop.tmp.dbname")+"."+tableName+"_result;\n"
				+ "set hivevar:FUNC_NAME="+tableName+"_Run;\n"
				+ "set hivevar:KEY_NAME=return_code;\n"
				+ "set hivevar:LOGIC_NAME="+tableName+";\n"
				+ "set hivevar:TMP1=tmp_"+tableName+"_Run;\n"
				+ "\n"
				+ "-----------------------------------------------------------------\n"
				+ "\n"
				+ "-- 算好轉檔的區間(起迄時間)\n"
				+ "-- 若為自動轉檔，則區間資訊從RUN_INFO取得\n"
				+ "-- 若為手動則直接抓參數DATA_S、DATA_E\n"
				+ "drop table ${hivevar:TMP1};\n"
				+ "create table ${hivevar:TMP1} as\n"
				+ "Select \n"
				+ "	case when '${hivevar:RUN_TYPE}' = 'A' then\n"
				+ "		case DATA_UNIT \n"
				+ "		when 'M' then date_format(trunc(add_months(current_date(), DATA_S), 'MM'),'yyyyMMdd')\n"
				+ "		when 'D' then date_format(date_add(current_date(), DATA_S),'yyyyMMdd')\n"
				+ "		when 'Y' then date_format(trunc(add_months(current_date(), DATA_S*12), 'YYYY'),'yyyyMMdd')\n"
				+ "		else '00000000' end \n"
				+ "	else '${hivevar:DATA_S}' end as YMDS\n"
				+ "	,case when '${hivevar:RUN_TYPE}' = 'A' then\n"
				+ "		case DATA_UNIT\n"
				+ "		when 'M' then date_format(last_day(trunc(add_months(current_date(), DATA_E), 'MM')),'yyyyMMdd')\n"
				+ "		when 'D' then date_format(date_add(current_date(), DATA_E),'yyyyMMdd')\n"
				+ "		when 'Y' then date_format(trunc(add_months(current_date(), DATA_E*12), 'YYYY'),'yyyy')||'1231'\n"
				+ "		else '00000000' end \n"
				+ "	else '${hivevar:DATA_E}' end as YMDE\n"
				+ "	,TABLENM\n"
				+ "	,current_timestamp() as CREATEDDATE\n"
				+ "FROM ${hivevar:SRC1_RUN} \n"
				+ "WHERE TRIM(TABLENM) = '${hivevar:Run_TableName}'\n"
				+ ";\n"
				+ "\n"
				+ "-- 先清除舊的轉檔資訊\n"
				+ "ALTER TABLE ${hivevar:DES1_RUN} DROP IF EXISTS PARTITION(TABLENM='${hivevar:Run_TableName}');\n"
				+ "\n"
				+ "-- 再將整理好的放入RUN_NOW裡\n"
				+ "INSERT OVERWRITE TABLE ${hivevar:DES1_RUN}\n"
				+ "PARTITION(TABLENM) \n"
				+ "Select YMDS,YMDE,CREATEDDATE,TRIM(TABLENM) from ${hivevar:TMP1};\n"
				+ "\n"
				+ "-- 清空驗証結果檔並重建\n"
				+ "drop table if exists ${hivevar:RSLT};\n"
				+ "create table if not exists ${hivevar:RSLT}\n"
				+ "(\n"
				+ "   alias       string,\n"
				+ "   batchid     bigint,\n"
				+ "   func_name   string,\n"
				+ "   msg         string,\n"
				+ "   msg_lvl     string,\n"
				+ "   rc          int,\n"
				+ "   create_time TIMESTAMP\n"
				+ ");\n"
				+ "\n"
				+ "\n"
				+ "-- verification \n"
				+ "-- 目前要跑的資料是否已存進RUN裡\n"
				+ "-- 0 => success; 1 => failure\n"
				+ "insert into table ${hivevar:RSLT}\n"
				+ "select \n"
				+ "   '${hivevar:LOGIC_NAME}',\n"
				+ "   ${hivevar:BATCHID},\n"
				+ "   '${hivevar:FUNC_NAME}',\n"
				+ "   '${hivevar:KEY_NAME}',\n"
				+ "   'info',\n"
				+ "   case when cnt > 0 then 0 else 1 end as rc,\n"
				+ "   current_timestamp() as create_time\n"
				+ "from (select COUNT(1) cnt \n"
				+ "	from ${hivevar:DES1_RUN} a join ${hivevar:TMP1} b \n"
				+ "	on a.TABLENM = b.TABLENM and a.YMDS = b.YMDS and a.YMDE = b.YMDE\n"
				+ "	) a\n"
				+ ";\n";
		
		return rs;
	}
	
	public static String getVAR(Map<String, String> mapProp, String tableName ) {
		
		String rs = "-----------------------------------------------------------------\n"
				+ "-- parameter list\n"
				+ "-----------------------------------------------------------------\n"
				+ "set hivevar:Run_TableName="+tableName+";\n"
				+ "set hivevar:RUN_TYPE=A;\n"
				+ "set hivevar:DATA_S=20221201;\n"
				+ "set hivevar:DATA_E=20221231;\n"
				+ "set hivevar:DES1_RUN="+mapProp.get("hadoop.std.dbname")+".SYS_RUN_NOW;\n"
				+ "set hivevar:SRC1_RUN="+mapProp.get("hadoop.std.dbname")+".SYS_RUN_INFO;\n"
				+ "\n"
				+ "set hivevar:BATCHID=20230329000000;\n"
				+ "set hivevar:RSLT="+mapProp.get("hadoop.tmp.dbname")+"."+tableName+"_result;\n"
				+ "set hivevar:FUNC_NAME="+tableName+"_Run;\n"
				+ "set hivevar:KEY_NAME=return_code;\n"
				+ "set hivevar:LOGIC_NAME="+tableName+";\n"
				+ "set hivevar:TMP1=tmp_"+tableName+"_Run;\n"
				+ "\n"
				+ "-----------------------------------------------------------------\n\n";
		
		return rs;
	}

}
