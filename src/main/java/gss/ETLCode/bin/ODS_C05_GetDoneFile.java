package gss.ETLCode.bin;

import java.util.Map;

public class ODS_C05_GetDoneFile {

	public static String getHQL(Map<String, String> mapProp, String tableName, String odsTableName, String finalLen, boolean hasChinese) {

		String rs = "-----------------------------------------------------------------\n"
				+ "-- parameter list\n"
				+ "-----------------------------------------------------------------\n"
				+ "set hivevar:BATCHID=20230329000000;\n"
				+ "set hivevar:FIX_LENGTH="+finalLen+";\n"
				+ "set hivevar:FILE_PATH=/user/post1/Upload/tmp;\n"
				+ "set hivevar:TAR_TABLE="+tableName+";\n"
				+ "set hivevar:RSLT="+mapProp.get("hadoop.tmp.dbname")+"."+tableName+"_result;\n"
				+ "set hivevar:SRC1_C05="+mapProp.get("hadoop.meta.dbname")+"."+odsTableName+"_files_name;\n"
				+ "set hivevar:DES1_C05="+mapProp.get("hadoop.meta.dbname")+"."+odsTableName+"_done_files;\n"
				+ "set hivevar:FUNC_NAME="+odsTableName+"_GetDoneData;\n"
				+ "set hivevar:KEY_NAME=return_code;\n"
				+ "set hivevar:LOGIC_NAME="+tableName+";\n"
				+ "set hivevar:TMP1=tmp_"+odsTableName+"_051;\n"
				+ "set hivevar:TMP2=tmp_"+odsTableName+"_052;\n"
				+ "set hivevar:TMP3=tmp_"+odsTableName+"_053;\n"
				+ "set hivevar:TMP4=tmp_"+odsTableName+"_054;\n"
				+ "-----------------------------------------------------------------\n"
				+ "\n"
				+ "\n"
				+ "-- Main logic\n"
				+ "--get right fix length data,even check length from last step\n"
				+ "drop table if exists ${hivevar:TMP1};\n"
				+ "\n"
				+ "create table if not exists ${hivevar:TMP1}\n"
				+ "as\n"
				+ "select *,LENGTH("+(hasChinese ? "ENCODE(LINE,'BIG5')" : "LINE")+") as FIX_LENGTH\n"
				+ "from  ${hivevar:SRC1_C05}\n"
				+ "WHERE LENGTH("+(hasChinese ? "ENCODE(LINE,'BIG5')" : "LINE")+") = ${hivevar:FIX_LENGTH}\n"
				+ ";\n"
				+ "\n"
				+ "\n"
				+ "--create done file\n"
				+ "DROP TABLE IF EXISTS ${hivevar:DES1_C05};\n"
				+ "\n"
				+ "CREATE TABLE  ${hivevar:DES1_C05}\n"
				+ "(\n"
				+ "file_name string,\n"
				+ "total_row bigint,\n"
				+ "data_from string,\n"
				+ "data_to string,\n"
				+ "exported_date string,\n"
				+ "exported_time string,\n"
				+ "create_time timestamp,\n"
				+ "batchid bigint\n"
				+ ")\n"
				+ ";\n"
				+ "\n"
				+ "drop table if exists ${hivevar:TMP2};\n"
				+ "create table ${hivevar:TMP2}\n"
				+ "as\n"
				+ "select file_name,file || '|' || case when line_type =1 then trim(line) else '' end as file,line,batchid,line_type\n"
				+ "from\n"
				+ "(\n"
				+ "select file_name,\n"
				+ "       SUBSTRING_INDEX(SUBSTR(file_name,locate('${hivevar:FILE_PATH}' || '/' || '${hivevar:TAR_TABLE}',file_name)),'/',-1)  as file,\n"
				+ "       -- line_type=1為表頭,2為表尾\n"
				+ "       case when length(trim(line)) = 8  then 1\n"
				+ "       else  2 end as line_type,\n"
				+ "       line,\n"
				+ "       batchid\n"
				+ "from (\n"
				+ "	SELECT *\n"
				+ "	FROM ${hivevar:TMP1}\n"
				+ "	where (trim(line) REGEXP '^[0-9]\\{8\\}$'\n"
				+ "		OR trim(line) REGEXP '^[0-9]\\{17\\}$')\n"
				+ "	)H\n"
				+ ")H1\n"
				+ ";\n"
				+ "\n"
				+ "\n"
				+ "\n"
				+ "--get file meta stat\n"
				+ "drop table if exists ${hivevar:TMP3};\n"
				+ "create table ${hivevar:TMP3}\n"
				+ "as\n"
				+ "select concat_ws(',',collect_list( case when line_type=1 then split(file,'\\\\|')[0] end )) as file_name,\n"
				+ "       sum(case when line_type=2 then cast(substr(trim(line),9) as bigint) else 0 end) as total_row,\n"
				+ "       '' as data_from,\n"
				+ "       '' as data_to,\n"
				+ "       concat_ws(',',collect_list( case when line_type=1 then split(file,'\\\\|')[1] end )) as exported_date,\n"
				+ "      ''  as exported_time,\n"
				+ "       max(batchid) as batchid\n"
				+ "from ${hivevar:TMP2}\n"
				+ ";\n"
				+ "\n"
				+ "\n"
				+ "\n"
				+ "insert into table  ${hivevar:DES1_C05}\n"
				+ "select\n"
				+ "  file_name,\n"
				+ "  total_row,\n"
				+ "  data_from,\n"
				+ "  data_to,\n"
				+ "  exported_date,\n"
				+ "  exported_time,\n"
				+ "  current_timestamp()   as create_time,\n"
				+ "  batchid\n"
				+ "from ${hivevar:TMP3}\n"
				+ ";\n"
				+ "\n"
				+ "-- verification\n"
				+ "\n"
				+ "drop table if exists ${hivevar:TMP4};\n"
				+ "create table ${hivevar:TMP4}\n"
				+ "as\n"
				+ "select\n"
				+ "count(1) as row_count\n"
				+ "from ${hivevar:DES1_C05}\n"
				+ "where total_row > 0\n"
				+ ";\n"
				+ "\n"
				+ "-- verification(2/2)\n"
				+ "-- secod, record the return code\n"
				+ "-- in this case\n"
				+ "-- row_count > 0 return 0\n"
				+ "-- else return 1\n"
				+ "\n"
				+ "-- 0 => success\n"
				+ "-- 1 => failure\n"
				+ "insert into table ${hivevar:RSLT}\n"
				+ "select\n"
				+ "   '${hivevar:LOGIC_NAME}' as alias,\n"
				+ "   ${hivevar:BATCHID},\n"
				+ "   '${hivevar:FUNC_NAME}',\n"
				+ "   '${hivevar:KEY_NAME}',\n"
				+ "   'info',\n"
				+ "   case\n"
				+ "      when row_count > 0 then 0\n"
				+ "      else 1\n"
				+ "   end as rc,\n"
				+ "   current_timestamp()   as create_time\n"
				+ "from ${hivevar:TMP4}\n"
				+ ";\n"
				+ "";
		
		return rs;
	}

	public static String getVAR(Map<String, String> mapProp, String tableName, String odsTableName, String finalLen) {

		String rs = "-----------------------------------------------------------------\n"
				+ "-- parameter list\n"
				+ "-----------------------------------------------------------------\n"
				+ "set hivevar:BATCHID=20230329000000;\n"
				+ "set hivevar:FIX_LENGTH="+finalLen+";\n"
				+ "set hivevar:FILE_PATH=/user/post1/Upload/tmp;\n"
				+ "set hivevar:TAR_TABLE="+tableName+";\n"
				+ "set hivevar:RSLT="+mapProp.get("hadoop.tmp.dbname")+"."+tableName+"_result;\n"
				+ "set hivevar:SRC1_C05="+mapProp.get("hadoop.meta.dbname")+"."+odsTableName+"_files_name;\n"
				+ "set hivevar:DES1_C05="+mapProp.get("hadoop.meta.dbname")+"."+odsTableName+"_done_files;\n"
				+ "set hivevar:FUNC_NAME="+odsTableName+"_GetDoneData;\n"
				+ "set hivevar:KEY_NAME=return_code;\n"
				+ "set hivevar:LOGIC_NAME="+tableName+";\n"
				+ "set hivevar:TMP1=tmp_"+odsTableName+"_051;\n"
				+ "set hivevar:TMP2=tmp_"+odsTableName+"_052;\n"
				+ "set hivevar:TMP3=tmp_"+odsTableName+"_053;\n"
				+ "set hivevar:TMP4=tmp_"+odsTableName+"_054;\n"
				+ "-----------------------------------------------------------------\n"
				+ "\n";
		
		return rs;
	}

}
